<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>OAuth HTTP Client Factory </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="OAuth HTTP Client Factory ">
      
      <link rel="icon" href="../favicon.png">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/veracity-engineering/SolutionPackageDoc/blob/master/docs/articles/DNVGL.OAuth.Api.HttpClient.md/#L1">
  </head>

  <script type="module">
    import options from './../public/main.js'
    import { init } from './../public/docfx.min.js'
    init(options)
  </script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="oauth-http-client-factory">OAuth HTTP Client Factory</h1>

<p>The <code>DNVGL.OAuth.Api.HttpClient package</code> is a .NET library which provides a factory for producing authenticated HttpClients for API integration via OAuth.</p>
<p>Developers can use this library to create HttpClient instances which will be pre-authenticated for API requests based on provided configuration.</p>
<p>This package supports two type of credential authentication:</p>
<ul>
<li>User credentials - A user may authenticate by providing a username and password via a UI.</li>
<li>Client credentials - A service or application may provide a client id and secret to silently authenticate.</li>
</ul>
<hr>
<h1 id="package-install">Package Install</h1>
<p>Ensure you have configured to package NuGet Package Source or find the instructions <a href="PackageInstall.html">here</a>.</p>
<p>Package Manager Console</p>
<pre><code>PM&gt; `Install-Package DNVGL.OAuth.Api.HttpClient`
</code></pre>
<h1 id="basic-example">Basic example</h1>
<h2 id="1-configuration">1. Configuration</h2>
<p>Setup API http client configuration in <code>appsettings.json</code> file:</p>
<pre><code class="lang-js">  {
    &quot;ApiHttpClientOptions&quot;: [
      {
        &quot;Name&quot;: &quot;userCredentialsClient&quot;,
        &quot;Flow&quot;: &quot;user-credentials&quot;,
        &quot;BaseUri&quot;: &quot;&lt;BaseUri&gt;&quot;,
        &quot;SubscriptionKey&quot;: &quot;&lt;SubscriptionKey&gt;&quot;
      },
      {
        &quot;Name&quot;: &quot;clientCredentialsClient&quot;,
        &quot;Flow&quot;:&quot;client-credentials&quot;,
        &quot;BaseUri&quot;: &quot;&lt;BaseUri&gt;&quot;,
        &quot;SubscriptionKey&quot;: &quot;&lt;SubscriptionKey&gt;&quot;
        &quot;OAuthClientOptions&quot;: {
          &quot;Authority&quot;: &quot;&lt;Authority&gt;&quot;,
          &quot;ClientId&quot;: &quot;&lt;ClientId&gt;&quot;,
          &quot;ClientSecret&quot;: &quot;&lt;ClientSecret&gt;&quot;,
          &quot;Resource&quot;: &quot;&lt;Resource&gt;&quot;,
          &quot;Scopes&quot;: [ &quot;&lt;Scope&gt;&quot;, &quot;offline_access&quot; ],
          &quot;CallbackPath&quot;: &quot;&lt;CallbackPath&gt;&quot;
        }
      }
    ]
  }

</code></pre>
<p>The package injects an <code>IHttpClientFactory</code> which is able to provide multiple HttpClients for different purposes.  The HttpClients may all be configured through a configuration section in which the individual client configurations are listed with a unique <code>Name</code> which is used to request HttpClients with the corresponding configurations.</p>
<p>The configuration shown above lists 2 HttpClients.  The first with name <code>&quot;userCredentialsClient&quot;</code> is an example of a configuration which would honour the signed in user's credentials for the API for which it makes requests.  The second with name <code>&quot;clientCredentialsClient&quot;</code> provides configuration for a client which would be authenticated via the client credential flow with a client id and secret to make requests in an API.  This configuration would allow us to request either type of HttpClient by requesting it from from the HttpClientFactory by providing one of the two names: <code>&quot;userCredentialsClient&quot;</code> or <code>&quot;clientCredentialsClient&quot;</code> in the method call to the HttpClientFactory.</p>
<h2 id="2-registration">2. Registration</h2>
<p>Call the <code>ServiceCollection</code> extension method <code>AddOAuthHttpClientFactory</code> to register an instance of the <code>IHttpClientFactory</code> in to your project in your <code>Startup.cs</code> file.</p>
<p>The below code is retrieving the configuration from the <code>&quot;OAuthHttpClientOptions&quot;</code> section defined in <code>apsettings.json</code> above.</p>
<pre><code class="lang-cs">public void ConfigureService(IServiceCollection services)
{
  ...
  services.AddOAuthHttpClientFactory(Congiuration.GetSection(&quot;ApiHttpClientOptions&quot;).Get&lt;IEnumerable&lt;OAuthHttpClientOptions&gt;&gt;());
  ...
}
</code></pre>
<p>If you require a HttpClient applying the user credential flow you should also include the web authentication (<code>AddOidc</code>) and token cache handling (<code>AddDistributedMemoryCache</code>) from the <a href="DNVGL.OAuth.Web.md">DNVGL.OAuth.Web</a> package.  Include the NuGet package in your project and call the required methods as below:</p>
<pre><code class="lang-cs">public void ConfigureService(IServiceCollection services)
{
  ...
  services.AddDistributedMemoryCache();
  ...
  var oidcOptions = new OidcOptions
  {
    Authority = &quot;&lt;Authority&gt;&quot;,
	  ClientId = &quot;&lt;ClientId&gt;&quot;,
	  ClientSecret = &quot;&lt;ClientSecret&gt;&quot;,
		Resource = &quot;&lt;Resource&gt;&quot;,
	  Scopes = new[] { &quot;&lt;Scope&gt;&quot;, &quot;offline_access&quot; },
	  ResponseType = OpenIdConnectResponseType.Code
  };
  services.AddOidc(oidcOptions);
  ...
  services.AddOAuthHttpClientFactory(Congiuration.GetSection(&quot;ApiHttpClientOptions&quot;).Get&lt;IEnumerable&lt;OAuthHttpClientOptions&gt;&gt;());
  ...
}
</code></pre>
<p>If you only require HttpClients applying the client credential flow the DNVGL.OAuth.Web package is not required.</p>
<h2 id="3-request-a-client">3. Request a client</h2>
<p>Resolve <code>IHttpClientFactory</code> to create user-credential or client-credential <code>HttpClient</code> to access web API.</p>
<pre><code class="lang-cs">public class TestController
{
  private readonly IHttpClientFactory _httpClientFactory;

  public TestController(IHttpClientFactory httpClientFactory)
  {
    _httpClientFactory = httpClientFactory;
  }

  public User DoSomethingWithSignInUser(string id)
  {
    var client = _httpClientFactory.Create(&quot;userCredentialsClient&quot;);
    ...
  }

  public Company DoSomethingWithService(string id)
  {
    var client = _httpClientFactory.Create(&quot;clientCredentialsClient&quot;);
    ...
  }
}
</code></pre>
</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/veracity-engineering/SolutionPackageDoc/blob/master/docs/articles/DNVGL.OAuth.Api.HttpClient.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>
        
      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top">
      <div class="container-xxl">
        <div class="flex-fill">
          godspeed
        </div>
      </div>
    </footer>
  </body>
</html>